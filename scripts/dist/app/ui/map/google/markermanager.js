function MarkerManager(e,t){var n=this;n.map_=e,n.mapZoom_=e.getZoom(),n.projection_=e.getCurrentMapType().getProjection(),t=t||{},n.tileSize_=MarkerManager.DEFAULT_TILE_SIZE_;var r=MarkerManager.DEFAULT_MAX_ZOOM_;t.maxZoom!=undefined&&(r=t.maxZoom),n.maxZoom_=r,n.trackMarkers_=t.trackMarkers;var i;typeof t.borderPadding=="number"?i=t.borderPadding:i=MarkerManager.DEFAULT_BORDER_PADDING_,n.swPadding_=new google.maps.Size(-i,i),n.nePadding_=new google.maps.Size(i,-i),n.borderPadding_=i,n.gridWidth_=[],n.grid_=[],n.grid_[r]=[],n.numMarkers_=[],n.numMarkers_[r]=0,google.maps.Event.bind(e,"moveend",n,n.onMapMoveEnd_),n.removeOverlay_=function(t){e.removeOverlay(t),n.shownMarkers_--},n.addOverlay_=function(t){e.addOverlay(t),n.shownMarkers_++},n.resetManager_(),n.shownMarkers_=0,n.shownBounds_=n.getMapGridBounds_()}MarkerManager.DEFAULT_TILE_SIZE_=1024,MarkerManager.DEFAULT_MAX_ZOOM_=17,MarkerManager.DEFAULT_BORDER_PADDING_=100,MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE=256,MarkerManager.prototype.resetManager_=function(){var e=this,t=MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE;for(var n=0;n<=e.maxZoom_;++n)e.grid_[n]=[],e.numMarkers_[n]=0,e.gridWidth_[n]=Math.ceil(t/e.tileSize_),t<<=1},MarkerManager.prototype.clearMarkers=function(){var e=this;e.processAll_(e.shownBounds_,e.removeOverlay_),e.resetManager_()},MarkerManager.prototype.getTilePoint_=function(e,t,n){var r=this.projection_.fromLatLngToPixel(e,t);return new google.maps.Point(Math.floor((r.x+n.width)/this.tileSize_),Math.floor((r.y+n.height)/this.tileSize_))},MarkerManager.prototype.addMarkerBatch_=function(e,t,n){var r=e.getPoint();this.trackMarkers_&&google.maps.Event.bind(e,"changed",this,this.onMarkerMoved_);var i=this.getTilePoint_(r,n,google.maps.Size.ZERO);for(var s=n;s>=t;s--){var o=this.getGridCellCreate_(i.x,i.y,s);o.push(e),i.x=i.x>>1,i.y=i.y>>1}},MarkerManager.prototype.isGridPointVisible_=function(e){var t=this,n=t.shownBounds_.minY<=e.y&&e.y<=t.shownBounds_.maxY,r=t.shownBounds_.minX,i=r<=e.x&&e.x<=t.shownBounds_.maxX;if(!i&&r<0){var s=t.gridWidth_[t.shownBounds_.z];i=r+s<=e.x&&e.x<=s-1}return n&&i},MarkerManager.prototype.onMarkerMoved_=function(e,t,n){var r=this,i=r.maxZoom_,s=!1,o=r.getTilePoint_(t,i,google.maps.Size.ZERO),u=r.getTilePoint_(n,i,google.maps.Size.ZERO);while(i>=0&&(o.x!=u.x||o.y!=u.y)){var a=r.getGridCellNoCreate_(o.x,o.y,i);a&&r.removeFromArray(a,e)&&r.getGridCellCreate_(u.x,u.y,i).push(e),i==r.mapZoom_&&(r.isGridPointVisible_(o)?r.isGridPointVisible_(u)||(r.removeOverlay_(e),s=!0):r.isGridPointVisible_(u)&&(r.addOverlay_(e),s=!0)),o.x=o.x>>1,o.y=o.y>>1,u.x=u.x>>1,u.y=u.y>>1,--i}s&&r.notifyListeners_()},MarkerManager.prototype.removeMarker=function(e){var t=this,n=t.maxZoom_,r=!1,i=e.getPoint(),s=t.getTilePoint_(i,n,google.maps.Size.ZERO);while(n>=0){var o=t.getGridCellNoCreate_(s.x,s.y,n);o&&t.removeFromArray(o,e),n==t.mapZoom_&&t.isGridPointVisible_(s)&&(t.removeOverlay_(e),r=!0),s.x=s.x>>1,s.y=s.y>>1,--n}r&&t.notifyListeners_()},MarkerManager.prototype.addMarkers=function(e,t,n){var r=this.getOptMaxZoom_(n);for(var i=e.length-1;i>=0;i--)this.addMarkerBatch_(e[i],t,r);this.numMarkers_[t]+=e.length},MarkerManager.prototype.getOptMaxZoom_=function(e){return e!=undefined?e:this.maxZoom_},MarkerManager.prototype.getMarkerCount=function(e){var t=0;for(var n=0;n<=e;n++)t+=this.numMarkers_[n];return t},MarkerManager.prototype.addMarker=function(e,t,n){var r=this,i=this.getOptMaxZoom_(n);r.addMarkerBatch_(e,t,i);var s=r.getTilePoint_(e.getPoint(),r.mapZoom_,google.maps.Size.ZERO);r.isGridPointVisible_(s)&&t<=r.shownBounds_.z&&r.shownBounds_.z<=i&&(r.addOverlay_(e),r.notifyListeners_()),this.numMarkers_[t]++},google.maps.Bounds.prototype.containsPoint=function(e){var t=this;return t.minX<=e.x&&t.maxX>=e.x&&t.minY<=e.y&&t.maxY>=e.y},MarkerManager.prototype.getGridCellCreate_=function(e,t,n){var r=this.grid_[n];e<0&&(e+=this.gridWidth_[n]);var i=r[e];if(!i)return i=r[e]=[],i[t]=[];var s=i[t];return s?s:i[t]=[]},MarkerManager.prototype.getGridCellNoCreate_=function(e,t,n){var r=this.grid_[n];e<0&&(e+=this.gridWidth_[n]);var i=r[e];return i?i[t]:undefined},MarkerManager.prototype.getGridBounds_=function(e,t,n,r){t=Math.min(t,this.maxZoom_);var i=e.getSouthWest(),s=e.getNorthEast(),o=this.getTilePoint_(i,t,n),u=this.getTilePoint_(s,t,r),a=this.gridWidth_[t];if(s.lng()<i.lng()||u.x<o.x)o.x-=a;u.x-o.x+1>=a&&(o.x=0,u.x=a-1);var f=new google.maps.Bounds([o,u]);return f.z=t,f},MarkerManager.prototype.getMapGridBounds_=function(){var e=this;return e.getGridBounds_(e.map_.getBounds(),e.mapZoom_,e.swPadding_,e.nePadding_)},MarkerManager.prototype.onMapMoveEnd_=function(){var e=this;e.objectSetTimeout_(this,this.updateMarkers_,0)},MarkerManager.prototype.objectSetTimeout_=function(e,t,n){return window.setTimeout(function(){t.call(e)},n)},MarkerManager.prototype.refresh=function(){var e=this;e.shownMarkers_>0&&e.processAll_(e.shownBounds_,e.removeOverlay_),e.processAll_(e.shownBounds_,e.addOverlay_),e.notifyListeners_()},MarkerManager.prototype.updateMarkers_=function(){var e=this;e.mapZoom_=this.map_.getZoom();var t=e.getMapGridBounds_();if(t.equals(e.shownBounds_)&&t.z==e.shownBounds_.z)return;t.z!=e.shownBounds_.z?(e.processAll_(e.shownBounds_,e.removeOverlay_),e.processAll_(t,e.addOverlay_)):(e.rectangleDiff_(e.shownBounds_,t,e.removeCellMarkers_),e.rectangleDiff_(t,e.shownBounds_,e.addCellMarkers_)),e.shownBounds_=t,e.notifyListeners_()},MarkerManager.prototype.notifyListeners_=function(){google.maps.Event.trigger(this,"changed",this.shownBounds_,this.shownMarkers_)},MarkerManager.prototype.processAll_=function(e,t){for(var n=e.minX;n<=e.maxX;n++)for(var r=e.minY;r<=e.maxY;r++)this.processCellMarkers_(n,r,e.z,t)},MarkerManager.prototype.processCellMarkers_=function(e,t,n,r){var i=this.getGridCellNoCreate_(e,t,n);if(i)for(var s=i.length-1;s>=0;s--)r(i[s])},MarkerManager.prototype.removeCellMarkers_=function(e,t,n){this.processCellMarkers_(e,t,n,this.removeOverlay_)},MarkerManager.prototype.addCellMarkers_=function(e,t,n){this.processCellMarkers_(e,t,n,this.addOverlay_)},MarkerManager.prototype.rectangleDiff_=function(e,t,n){var r=this;r.rectangleDiffCoords(e,t,function(t,i){n.apply(r,[t,i,e.z])})},MarkerManager.prototype.rectangleDiffCoords=function(e,t,n){var r=e.minX,i=e.minY,s=e.maxX,o=e.maxY,u=t.minX,a=t.minY,f=t.maxX,l=t.maxY;for(var c=r;c<=s;c++){for(var h=i;h<=o&&h<a;h++)n(c,h);for(var h=Math.max(l+1,i);h<=o;h++)n(c,h)}for(var h=Math.max(i,a);h<=Math.min(o,l);h++){for(var c=Math.min(s+1,u)-1;c>=r;c--)n(c,h);for(var c=Math.max(r,f+1);c<=s;c++)n(c,h)}},MarkerManager.prototype.removeFromArray=function(e,t,n){var r=0;for(var i=0;i<e.length;++i)if(e[i]===t||n&&e[i]==t)e.splice(i--,1),r++;return r};