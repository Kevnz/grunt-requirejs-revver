var globalMap=null;define(["jquery","jqueryui","app/ui/map/google/markermanager"],function($){function ShowRedZone(e){var t=[new GLatLng(-43.529991,172.634323),new GLatLng(-43.53006,172.634247),new GLatLng(-43.530041,172.634171),new GLatLng(-43.530602,172.633484),new GLatLng(-43.530762,172.633453),new GLatLng(-43.530861,172.633438),new GLatLng(-43.530941,172.633255),new GLatLng(-43.53101,172.633255),new GLatLng(-43.53133,172.633301),new GLatLng(-43.531891,172.633713),new GLatLng(-43.531891,172.633896),new GLatLng(-43.531971,172.633896),new GLatLng(-43.531971,172.635193),new GLatLng(-43.531712,172.635193),new GLatLng(-43.531712,172.635773),new GLatLng(-43.532471,172.635773),new GLatLng(-43.532471,172.636536),new GLatLng(-43.534191,172.636566),new GLatLng(-43.534302,172.636703),new GLatLng(-43.535061,172.636703),new GLatLng(-43.535061,172.636963),new GLatLng(-43.53532,172.636963),new GLatLng(-43.535271,172.639664),new GLatLng(-43.535061,172.639664),new GLatLng(-43.53508,172.640137),new GLatLng(-43.534821,172.640427),new GLatLng(-43.535091,172.640793),new GLatLng(-43.535061,172.640884),new GLatLng(-43.535252,172.641068),new GLatLng(-43.535252,172.642563),new GLatLng(-43.533051,172.642548),new GLatLng(-43.53307,172.642136),new GLatLng(-43.53315,172.642136),new GLatLng(-43.533131,172.640656),new GLatLng(-43.532021,172.64064),new GLatLng(-43.532021,172.641953),new GLatLng(-43.530972,172.641953),new GLatLng(-43.530972,172.639771),new GLatLng(-43.530861,172.639542),new GLatLng(-43.530861,172.639175),new GLatLng(-43.530621,172.639175),new GLatLng(-43.530621,172.638504),new GLatLng(-43.530861,172.638504),new GLatLng(-43.530861,172.638016),new GLatLng(-43.52993,172.638),new GLatLng(-43.52993,172.636703),new GLatLng(-43.530209,172.636703),new GLatLng(-43.530209,172.636581),new GLatLng(-43.529938,172.636581),new GLatLng(-43.529911,172.634476),new GLatLng(-43.529991,172.634323)],n=[new GLatLng(-43.529812,172.636703),new GLatLng(-43.529812,172.638016),new GLatLng(-43.529861,172.638016),new GLatLng(-43.529854,172.638657),new GLatLng(-43.529781,172.638641),new GLatLng(-43.529789,172.639557),new GLatLng(-43.528812,172.639542),new GLatLng(-43.527557,172.639542),new GLatLng(-43.527561,172.639252),new GLatLng(-43.526791,172.639252),new GLatLng(-43.526791,172.639557),new GLatLng(-43.525532,172.639526),new GLatLng(-43.525551,172.637024),new GLatLng(-43.525791,172.637054),new GLatLng(-43.52581,172.636703),new GLatLng(-43.526501,172.636688),new GLatLng(-43.526505,172.636505),new GLatLng(-43.526505,172.636215),new GLatLng(-43.526043,172.63623),new GLatLng(-43.526039,172.636002),new GLatLng(-43.525543,172.635971),new GLatLng(-43.525555,172.635239),new GLatLng(-43.526485,172.635239),new GLatLng(-43.526485,172.634933),new GLatLng(-43.526657,172.634949),new GLatLng(-43.526661,172.634674),new GLatLng(-43.527309,172.634689),new GLatLng(-43.527325,172.635208),new GLatLng(-43.527702,172.635223),new GLatLng(-43.52779,172.635345),new GLatLng(-43.527668,172.635666),new GLatLng(-43.527588,172.635971),new GLatLng(-43.527405,172.636368),new GLatLng(-43.527191,172.636536),new GLatLng(-43.528717,172.636536),new GLatLng(-43.528725,172.63591),new GLatLng(-43.528507,172.63591),new GLatLng(-43.528515,172.635422),new GLatLng(-43.52874,172.635406),new GLatLng(-43.528744,172.635025),new GLatLng(-43.528847,172.634949),new GLatLng(-43.528843,172.634781),new GLatLng(-43.529202,172.63472),new GLatLng(-43.529503,172.634521),new GLatLng(-43.5298,172.634247),new GLatLng(-43.529812,172.634338),new GLatLng(-43.529648,172.634506),new GLatLng(-43.529671,172.634583),new GLatLng(-43.529789,172.634659),new GLatLng(-43.529812,172.63652),new GLatLng(-43.529655,172.63652),new GLatLng(-43.529655,172.636703),new GLatLng(-43.529812,172.636703)],r=new GPolygon(t,"#ff0000",2,.7,"#ff0000",.35),i=new GPolygon(n,"#ff0000",2,.7,"#ff0000",.35);e.addOverlay(r),e.addOverlay(i)}function ShowAllCategories(e){var t=new Array,n=0;$(".g-map-container .category input:checked").each(function(){t[n]=$(this).val(),n++}),ShowMarkers(e,t)}function ShowOnly(e){var t=FindMap(),n=[];for(var r=0;r<t.data.locations.length;r++)if(t.data.locations[r].id==e){AddMarkerToArray(n,t,t.data.locations[r]);break}n.length>0&&($(".g-map-container .category input").each(function(){this.checked=!1}),ShowMarkers(FindMap(null),[]),t.markerManager||(t.markerManager=new MarkerManager(t)),t.markerManager.clearMarkers(),t.markerManager.addMarkers(n,0,17),t.markerManager.refresh(),DoMarkerClick(t,n[0]))}function ShowMarkers(e,t){e.markerManager||(e.markerManager=new MarkerManager(e)),e.markerManager.clearMarkers();var n=[];for(var r=0;r<e.data.locations.length;r++){var i=-1;for(var s=0;s<e.data.locations[r].categories.length;s++)for(var o=0;o<t.length;o++)t[o]==e.data.locations[r].categories[s]&&(i=t[o]);i>-1&&AddMarkerToArray(n,e,e.data.locations[r])}e.markerManager.addMarkers(n,0,17),e.markerManager.refresh()}function AddMarkerToArray(e,t,n){var r=n.membershipType=="platinum",i=new google.maps.LatLng(n.lat,n.lng),s=new google.maps.Icon(baseIcon),o=t.data.categories[n.markerCategory];s.image="/images/interface/map/markers/"+o.cssClass+".png";var u=new google.maps.Marker(i,s);u.data=n,u.cssClass=o.cssClass,u.imageLo="/images/Interface/map/markers/"+o.cssClass+".png",u.imageHi="/images/Interface/map/markers/"+o.cssClass+".png",google.maps.Event.addListener(u,"mouseover",function(){u.setImage(u.imageHi)}),google.maps.Event.addListener(u,"mouseout",function(){$(".g-map-info.marker-"+u.data.id).length==0&&u.setImage(u.imageLo)}),google.maps.Event.addListener(u,"click",function(){DoMarkerClick(t,u)}),e.push(u)}function DoMarkerClick(e,t){t.setImage(t.imageHi),$(".g-map-info").length==0&&$(e.getContainer()).append("<div class='g-map-info'></div>"),$(".g-map-info").data.marker=t,$(".g-map-info").attr("class","g-map-info width-wrap loading marker-"+t.data.id+" "+t.cssClass).html('<p class="g-map-info-loader">loading...</p>'),$(".g-map-info").fadeIn(),$.ajax({url:"/"+t.data.id+"?altTemplate=InfoPane",dataType:"html",success:function(e){$(".g-map-info").removeClass("loading").html(e),$(".g-map-info .inner").height()>300&&($(".g-map-info .inner").html('<div class="overflow-catcher">'+$(".g-map-info .inner").html()+"</div>"),$(".g-map-info .inner").css({padding:"35px 5px 5px 20px"}))},error:function(e,t,n){$(".g-map-info").html("<div class='inner'><h2>Sorry, There was a problem loading this info.</h2><p>"+t+"</p></div>")}}),e.panTo(new google.maps.LatLng(t.data.lat,t.data.lng))}function CreateGMap(e){if(google.maps.BrowserIsCompatible()){var t=new google.maps.Map2(e);DefaultView(t),t.enableScrollWheelZoom(),t.setMapType(G_NORMAL_MAP),AddCustomMapTypeButtons(t);var n=new google.maps.OverviewMapControl(new google.maps.Size(130,200));return t.addControl(n),AddCustomNavigation(t),$(".g-map-container div:not(.g-map-info)").mousedown(function(){ClearSelection(t)}),$(".g-map-container").on("mousedown",".category",function(){ClearSelection(t)}),$(".g-map-container").on("click",".g-map-info-close",function(){ClearSelection(t)}),google.maps.Event.addListener(t,"zoomend",function(e,n){ClearSelection(t)}),$.publish("/googlemap/resize-container"),t}}function ClearSelection(e){if($(".g-map-info").length>0){var t=$(".g-map-info").data.marker;t.setImage(t.imageLo),$(".g-map-info").remove()}}function AddCustomMapTypeButtons(e){$(e.getContainer()).append("<div class='width-wrap'><div class='type'><a class='map selected pod-heading' title='map'>Map</a><a class='satellite pod-heading' title='satelite'>Satellite</a><a class='terrain pod-heading' title='terrain'>Terrain</a></div></div>"),$(".g-map-container .type .map").click(function(){e.setMapType(G_NORMAL_MAP),$(this).addClass("selected").siblings().removeClass("selected")}),$(".g-map-container .type .terrain").click(function(){e.setMapType(G_PHYSICAL_MAP),$(this).addClass("selected").siblings().removeClass("selected")}),$(".g-map-container .type .satellite").click(function(){e.setMapType(G_SATELLITE_MAP),$(this).addClass("selected").siblings().removeClass("selected")});var t=new google.maps.ControlPosition(G_ANCHOR_TOP_RIGHT,new GSize(0,7));t.apply($(".g-map-container .type")[0])}function AddCategoriesNavigation(e){$(".g-map-container .category").remove(),$(e.getContainer()).append("<div class='width-wrap'><div class='category'><h4><div class='toggle' title='Show/Hide Categories' />Show on the map</h4><div class='body'></div></div></div>"),$(".g-map-container .category .toggle").click(function(){$(this).toggleClass("closed"),$(this).parent().toggleClass("closed"),$(".category .body").slideToggle()});var t=0,n,r={};for(var i=0;i<e.data.categories.length;i++)r[e.data.categories[i].id]=e.data.categories[i].id;for(var i=0;i<e.data.categories.length;i++){var s,o=$(".g-map-container").data("showOneCategory","");e.data.categories[i].level==1&&(e.data.categories[i].showCategory||e.data.categories[i].name=="Miscelaneous"?o!=undefined&&o!=null&&o!=""&&o in r?(n=o==e.data.categories[i].id?'checked="checked"':"",$(".g-map-container").data("showOneCategory",o)):n='checked="checked"':n="",t=i),e.data.categories[i].showCategory?CssClass=e.data.categories[i].cssClass:CssClass="hidden",$(".g-map-container .category .body").append('<label class="png '+CssClass+"\"><input type='checkbox' value='"+i+"' "+n+' rel="'+(t!=i?t:"")+'" /><span class="iconf-'+CssClass+'"></span>'+e.data.categories[i].name+"</label>")}$(".g-map-container .reload-markers").click(function(){google.maps.DownloadUrl("/scripts/src/app/ui/map/google/LocationList.json.aspx",ProcessJson)}),$(".g-map-container .category input").click(function(){var t=$(this).get(0).checked;$(".g-map-container .category input[rel="+$(this).val()+"]").each(function(){this.checked=t}),categoryChanged(e)})}function categoryChanged(e){var t=new Array,n=0;$(".g-map-container .category input:checked").each(function(){t[n]=$(this).val(),n++}),ShowMarkers(e,t)}function AddCustomNavigation(e){$(e.getContainer()).append("<div class='width-wrap'><div class='nav'><div class='pan'><a class='north'></a><a class='west'></a><a class='centre'></a><a class='east'></a><a class='south'></a></div><div class='zoom'><a class='in'></a><div class='slider'></div><a class='out'></a></div></div></div>"),$(".g-map-container .pan .north").click(function(){e.panDirection(0,1)}),$(".g-map-container .pan .west").click(function(){e.panDirection(1,0)}),$(".g-map-container .pan .centre").click(function(){e.returnToSavedPosition()}),$(".g-map-container .pan .east").click(function(){e.panDirection(-1,0)}),$(".g-map-container .pan .south").click(function(){e.panDirection(0,-1)}),$(".g-map-container .zoom .in").click(function(){e.zoomIn()}),$(".g-map-container .zoom .out").click(function(){e.zoomOut()});var t=e.getZoom();$(".g-map-container .zoom .slider").slider({orientation:"vertical",handle:".ui-slider-handle",value:t,min:0,max:17,step:1,slide:function(t,n){e.setZoom(n.value)}}),$(".g-map-container .zoom .slider").slider("value",t),google.maps.Event.addListener(e,"zoomend",function(e,t){$(".zoom .slider").slider("value",t)})}function DefaultView(e){e.setCenter(new google.maps.LatLng(-43.53164036353273,172.63667106628418),8)}function SetBaseIcon(){baseIcon=new google.maps.Icon,baseIcon.shadow="/images/interface/map/shadow.png",baseIcon.iconSize=new google.maps.Size(29,28),baseIcon.shadowSize=new google.maps.Size(52,28),baseIcon.iconAnchor=new google.maps.Point(14,28),baseIcon.infoWindowAnchor=new google.maps.Point(9,2),baseIcon.infoShadowAnchor=new google.maps.Point(18,25)}function FindMap(e){return globalMap}var $gmapContainer,mapLoaded=!1,module;return ProcessJson=function(doc){var theMap=FindMap($gmapContainer[0]),jsonData=eval("("+doc+")");theMap.data=jsonData,DefaultView(theMap),AddCategoriesNavigation(theMap),ShowAllCategories(theMap)},{init:function(){$gmapContainer=$(".g-map-container"),this._initSubscriptions(),module=this},_initSubscriptions:function(){$.subscribe("/googlemap/toggle-complete",this._loadMap),$.subscribe("/googlemap/resize-map",this._resizeMap)},_loadMap:function(e){var t=e.ref;if(!mapLoaded){module._createMap(t);return}t!==0&&ShowOnly(t),$.publish("/googlemap/resize")},_createMap:function(e){SetBaseIcon(),$gmapContainer.each(function(){globalMap=CreateGMap(this,"large"),google.maps.DownloadUrl("/scripts/src/app/ui/map/google/LocationList.json.aspx",function(t){ProcessJson(t),e&&ShowOnly(e),ShowRedZone(globalMap)})}),mapLoaded=!0},_resizeMap:function(){var e=FindMap();e&&e.checkResize()}}});