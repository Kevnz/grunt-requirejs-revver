define(["jquery","pubsub"],function(e){var t=null,n=null,r=null,i="&deg;",s=e("#js-weather").data("woeid"),o={tornado:"tornado",tropicalstorm:"",hurricane:"hurricane",severethunderstorms:"thunder",thunderstorms:"thunder",mixedrainandsnow:"snowshower",mixedrainandsleet:"snowshower",mixedsnowandsleet:"snowshower",freezingdrizzle:"drizzle",lightdrizzle:"drizzle",drizzle:"drizzle",rain:"shower",showersinthevicinity:"shower",freezingrain:"shower",showers:"shower",snowflurries:"snowflurries",lightsnowshowers:"snowshower",blowingsnow:"snow",snow:"snow",hail:"hail",sleet:"hail",dust:"foggy",foggy:"foggy",haze:"foggy",smoky:"foggy",blustery:"windy",windy:"windy",cold:"cold",cloudy:"cloudy",mostlycloudy:"cloudy",mostlycloudynight:"cloudy",mostlycloudyday:"cloudy",partlycloudynight:"cloudy",partlycloudyday:"cloudy",clearnight:"clearnight",sunny:"sunny",fair:"sunny",fairnight:"fairnight",fairday:"sunny",mixedrainandhail:"snowshower",hot:"sunny",isolatedthunderstorms:"thunder",scatteredthunderstorms:"thunder",rainshower:"shower",lightrainshower:"shower",scatteredshowers:"shower",scatteredsnowshowers:"shower",heavysnow:"snow",partlycloudy:"cloudy",thundershowers:"showthunder",snowshowers:"snowshower",isolatedthundershowers:"showthunder",notavailable:""},u={time:"",temp:"",forecast:"",date:"",icon:""};return{init:function(){t=new Date,n=this._generateTimestamp(),r="http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20weather.forecast%20where%20woeid%3D"+s+"&format=json&_maxage=3600&rnd=_"+n,this._retrieveWeather()},_retrieveWeather:function(){var e=this;require(["async!"+r],function(t){e._processResponse(t)})},_processResponse:function(e){this._setForecast(e)},_setForecast:function(t){if(!t||!t.query||!t.query.results)return;var n=t.query.results,r=n.channel.item.condition,s=this._parseForecast(r.text);u.time=this._currentTime(),u.temp=this._convertToCelsius(r.temp)+i+" C",u.forecast=r.text,u.date=this._removeTimeFromResponse(r.date),u.icon=this._getWeatherIcon(s),u.icon||console.log("Icon needed for weather forecast:",s),e.publish("/weather/ready",u)},_getWeatherIcon:function(e){return o[e]||""},_parseForecast:function(e){return e.toLowerCase().replace(/[\s\(\)]/g,"")},_generateTimestamp:function(){return t.getUTCFullYear()+(t.getUTCMonth()+1+"")+(t.getUTCDate()+1+"")+t.getHours()},_currentTime:function(){var e=(t.getMinutes()+"").length==1?"0"+t.getMinutes():t.getMinutes();return t.getHours()+":"+e},_removeTimeFromResponse:function(e){var t=/\d{1,2}:\d{1,2}\s?(am|pm)\s?/;return e.replace(t,"")},_convertToCelsius:function(e){return Math.round((e-32)/1.8)}}});