define(["jquery","pubsub"],function(e,t){return{_$pagination:null,init:function(){this._getPagination(),this._initSubscriptions(),this._setupAjaxUrls()},_initSubscriptions:function(){e.subscribe("/pagination/next",e.proxy(this._processNext,this)),e.subscribe("/pagination/update",e.proxy(this._processUpdate,this)),e.subscribe("/listing/complete",e.proxy(this._updateFirstPagination,this))},_processUpdate:function(e){this._getPagination(),this._updateValues(e),this._updateSelected(),this._updatePageNumber(),this._insertPagination()},_updateFirstPagination:function(){var t=e(".js-listing-infinite").children("li").length;e(".js-pagination").first().find(".js-pagination-end").text(t)},_processNext:function(){var e=this._getNextPageUrl(),t=this._hasMoreResults(),n={url:e,hasMore:t};this._publishUrlEvent(n)},_getPagination:function(){return this._$pagination=e(".js-pagination").eq(0).clone(),this._$pagination},_updateValues:function(e){this._$pagination.find(".js-pagination-start").text(e.start),this._$pagination.find(".js-pagination-end").text(e.end)},_insertPagination:function(){e(".js-listing-infinite").last().after(this._$pagination)},_getNextPageUrl:function(){var t=e(".js-pagination-pages").eq(0),n=t.find(".is-selected"),r=n.closest("li").next("li").find("a")[0];return r!=undefined?r.href:-1},_hasMoreResults:function(){var t=e(".js-pagination-pages").eq(0);return!!t.find(".is-selected").closest("li").next().next().length},_getPageSize:function(){var e=this._$pagination.find(".js-pagination-pages").attr("data-url"),t=e.substring(e.lastIndexOf("/"),e.length);return parseInt(/\d+/.exec(t)[0],10)},_getPageNumberFromUrl:function(e){var t=/PageNumber=\d+/.exec(e);return t||(t=/page=\d+/.exec(e)),t?/\d+/.exec(t[0])[0]:1},_getNextStartingPoint:function(e){return e*this._getPageSize()-this._getPageSize()+1},_getNewUrl:function(e){var t=this._$pagination.find(".js-pagination-pages").attr("data-url"),n=this._getPageNumberFromUrl(e),r=this._getNextStartingPoint(n),i=t.substring(0,t.lastIndexOf("/")),s=i.substring(0,i.lastIndexOf("/")),o="";return t.indexOf("?")>1&&(o=t.substring(t.indexOf("?"))),s+"/"+r+"/"+this._getPageSize()+o},_setupAjaxUrls:function(){var t=this,n=e(".js-pagination-pages").eq(0);n.find("a").each(function(){var n=e(this);n.attr("href",t._getNewUrl(n.attr("href")))})},_publishUrlEvent:function(t){e.publish("/pagination/url",[t])},_updateSelected:function(){var t=e(".js-pagination-pages").eq(0),n=t.find(".is-selected"),r=n.closest("li").next("li");n.removeClass("is-selected"),r.find("a").addClass("is-selected")},_updatePageNumber:function(){var t=e(".js-pagination-pages").eq(0),n=t.find("li"),r=t.find(".is-selected").closest("li"),i=parseInt(n.index(r),10)+1;this._$pagination.find(".js-pagination-page-number").text(i),this._$pagination.find(".js-pagination-page-number").closest(".js-pagination").addClass("hidden")}}});